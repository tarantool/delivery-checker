name: Deploy
on:
  workflow_dispatch:
  push:
    branches: ['master']
jobs:
  deploy_code:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@master
      - name: Uninstall bot service
        uses: garygrossgarten/github-action-ssh@release
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          privateKey: ${{ secrets.SSH_KEY }}
          command: |
            cd ${{ secrets.REMOTE_PATH }}
            test -f service.sh && ./service.sh uninstall
      - name: Clear old files
        uses: garygrossgarten/github-action-ssh@release
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          privateKey: ${{ secrets.SSH_KEY }}
          command: |
            cd ${{ secrets.REMOTE_PATH }}
            find . -maxdepth 1 \
              -not -name '.' \
              -not -name 'config.json' \
              -not -name 'bot.db' \
              -not -name 'archive' \
              -print0 | sudo xargs -0 rm -rfv --
      - name: Send new files
        uses: garygrossgarten/github-action-scp@release
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          privateKey: ${{ secrets.SSH_KEY }}
          local: "./"
          remote: "${{ secrets.REMOTE_PATH }}/"
      - name: Install dependences
        uses: garygrossgarten/github-action-ssh@release
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          privateKey: ${{ secrets.SSH_KEY }}
          command: |
            cd ${{ secrets.REMOTE_PATH }}
            git reset --hard
            python3 -m venv venv
            venv/bin/pip install --upgrade pip
            venv/bin/pip install -r requirements.txt
      - name: Check config
        uses: garygrossgarten/github-action-ssh@release
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          privateKey: ${{ secrets.SSH_KEY }}
          command: |
            cd ${{ secrets.REMOTE_PATH }}
            ls config.json || cp config-example.json config.json
      - name: Install bot service
        uses: garygrossgarten/github-action-ssh@release
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          privateKey: ${{ secrets.SSH_KEY }}
          command: |
            cd ${{ secrets.REMOTE_PATH }}
            ./service.sh install
